#!/bin/bash
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "usage:"
    echo "user <username> <full name> [shell]"
    exit 5
fi

if ! [ "$UID" == "0" ]; then
    echo "this script must be run with super user privileges"
    exit 6
fi

# Set default shell or use provided shell
SHELL_PATH="/usr/bin/bash"

if [ -n "$3" ]; then
    # Check if the provided shell exists in /etc/shells
    if grep -q "^$3$" /etc/shells; then
        SHELL_PATH="$3"
    else
        echo "Warning: Shell '$3' not found in /etc/shells. Using default /usr/bin/bash"
    fi
fi

if ! read -r PASSWORD_STDIN; then
    echo "Error: failed to read password from stdin"
    exit 7
fi

homectl create "$1" \
    --real-name "$2" \
    --shell "$SHELL_PATH" \
    --member-of "sudo,adm,lpadmin" \
    --storage=luks \
    --luks-discard=yes \
    --password "$PASSWORD_STDIN"
